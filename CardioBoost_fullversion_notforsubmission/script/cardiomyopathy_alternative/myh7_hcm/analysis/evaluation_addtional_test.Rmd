---
title: "Evaluation on additional test data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 
```{r}
rm(list=ls())
library(dplyr)
library(mlr)
set.seed(123)
setwd("./")

source("../../src/permutation_test.R")
load("../../../data/cardiomyopathy/prediction/cm_prediction.RData")
load("../../../data/cardiomyopathy/preprocess.RData")
```


### Pathogenic test set 1 (SHaRe): True positive rate at P>0.9
```{r}
#get the prediction on test variants
load("../../../data/cardiomyopathy/cm_additional_test_patho.RData")

cm_patho_test$key<-paste(cm_patho_test$CHROM,cm_patho_test$POS,cm_patho_test$REF,cm_patho_test$ALT,sep="_")
cm_patho_test$pathogenicity<-cm_prediction[match(cm_patho_test$key,cm_prediction$key),]$pathogenicity
cm_patho_test$MCAP<-cm_prediction[match(cm_patho_test$key,cm_prediction$key),]$MCAP
cm_patho_test$REVEL<-cm_prediction[match(cm_patho_test$key,cm_prediction$key),]$REVEL
cm_patho_test$pathogenic=1


subset="SHaRe"
print(paste(subset,":CardioBoost","MCAP","REVEL",sep=" "))
cm_patho_test_subset<-subset(cm_patho_test,source==subset)
nrow(cm_patho_test_subset)
print(round(c(measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$pathogenicity>=0.90,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$MCAP>=0.90,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$REVEL>=0.90,1,0),1))*100,1))

data_set<-function(test,classifer){
  data<-subset(cm_patho_test,source==test)
  data<-data[,c("pathogenic",classifer)]
  colnames(data)<-c("class","prob_pathogenic")
  data
}

tpr.f<-function(d){
  data<-d
  measureTPR(data$class,ifelse(data$prob_pathogenic>=0.90,1,0),1)
}

p_ada<-data_set("SHaRe","pathogenicity")
p_mcap<-data_set("SHaRe","MCAP")

permutation(p_ada,p_mcap,fun=tpr.f,n=10000)



```

### Pathogenic test set 1 (SHaRe): True positive rate at P>0.95
```{r}
#get the prediction on test variants
load("../../../data/cardiomyopathy/cm_additional_test_patho.RData")

cm_patho_test$key<-paste(cm_patho_test$CHROM,cm_patho_test$POS,cm_patho_test$REF,cm_patho_test$ALT,sep="_")
cm_patho_test$pathogenicity<-cm_prediction[match(cm_patho_test$key,cm_prediction$key),]$pathogenicity
cm_patho_test$MCAP<-cm_prediction[match(cm_patho_test$key,cm_prediction$key),]$MCAP
cm_patho_test$REVEL<-cm_prediction[match(cm_patho_test$key,cm_prediction$key),]$REVEL
cm_patho_test$pathogenic=1


subset="SHaRe"
print(paste(subset,":CardioBoost","MCAP","REVEL",sep=" "))
cm_patho_test_subset<-subset(cm_patho_test,source==subset)
nrow(cm_patho_test_subset)
print(round(c(measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$pathogenicity>=0.95,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$MCAP>=0.95,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$REVEL>=0.95,1,0),1))*100,1))

data_set<-function(test,classifer){
  data<-subset(cm_patho_test,source==test)
  data<-data[,c("pathogenic",classifer)]
  colnames(data)<-c("class","prob_pathogenic")
  data
}

tpr.f<-function(d){
  data<-d
  measureTPR(data$class,ifelse(data$prob_pathogenic>=0.95,1,0),1)
}

p_ada<-data_set("SHaRe","pathogenicity")
p_mcap<-data_set("SHaRe","MCAP")

permutation(p_ada,p_mcap,fun=tpr.f,n=10000)



```


### Pathogenic test set 2 (ClinVar): true pathogenic rate at P>0.9
```{r}
subset="ClinVar"
print(paste(subset,":CardioBoost","MCAP","REVEL",sep=" "))
cm_patho_test_subset<-subset(cm_patho_test,source==subset)
nrow(cm_patho_test_subset)
print(round(c(measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$pathogenicity>=0.90,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$MCAP>=0.90,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$REVEL>=0.90,1,0),1))*100,1))

p_ada<-data_set("ClinVar","pathogenicity")
p_revel<-data_set("ClinVar","REVEL")

permutation(p_ada,p_revel,fun=tpr.f,n=10000)

```

### Pathogenic test set 2 (ClinVar): true pathogenic rate at P>0.95
```{r}
subset="ClinVar"
print(paste(subset,":CardioBoost","MCAP","REVEL",sep=" "))
cm_patho_test_subset<-subset(cm_patho_test,source==subset)
nrow(cm_patho_test_subset)
print(round(c(measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$pathogenicity>=0.95,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$MCAP>=0.95,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$REVEL>=0.95,1,0),1))*100,1))

p_ada<-data_set("ClinVar","pathogenicity")
p_mcap<-data_set("ClinVar","MCAP")

permutation(p_ada,p_mcap,fun=tpr.f,n=10000)

```

### Pathogenic test set 3 (HGMD): true pathogenic rate at P>0.9
```{r}
subset="HGMD"
print(paste(subset,":CardioBoost","MCAP","REVEL",sep=" "))
cm_patho_test_subset<-subset(cm_patho_test,source==subset)
nrow(cm_patho_test_subset)
print(round(c(measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$pathogenicity>=0.90,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$MCAP>=0.90,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$REVEL>=0.90,1,0),1))*100,1))

p_ada<-data_set("HGMD","pathogenicity")
p_mcap<-data_set("HGMD","MCAP")

permutation(p_ada,p_mcap,fun=tpr.f,n=10000)

```

### Pathogenic test set 3 (HGMD): true pathogenic rate at P>0.95
```{r}
subset="HGMD"
print(paste(subset,":CardioBoost","MCAP","REVEL",sep=" "))
cm_patho_test_subset<-subset(cm_patho_test,source==subset)
nrow(cm_patho_test_subset)
print(round(c(measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$pathogenicity>=0.95,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$MCAP>=0.95,1,0),1),
measureTPR(cm_patho_test_subset$pathogenic,ifelse(cm_patho_test_subset$REVEL>=0.95,1,0),1))*100,1))

p_ada<-data_set("HGMD","pathogenicity")
p_mcap<-data_set("HGMD","MCAP")

permutation(p_ada,p_mcap,fun=tpr.f,n=10000)

```

### Benign test set 1 (gnomAD): true negative rate at P<0.1
```{r}
load("../../../data/cardiomyopathy/cm_additional_test_benign.RData")

cm_gnomad_rare$key<-paste(cm_gnomad_rare$CHROM,cm_gnomad_rare$POS,cm_gnomad_rare$REF,cm_gnomad_rare$ALT,sep="_")
cm_gnomad_rare<-cm_gnomad_rare[which(is.element(cm_gnomad_rare$key,cm_prediction$key)==TRUE),]
cm_gnomad_rare$pathogenicity<-cm_prediction[match(cm_gnomad_rare$key,cm_prediction$key),]$pathogenicity
cm_gnomad_rare$MCAP<-cm_prediction[match(cm_gnomad_rare$key,cm_prediction$key),]$MCAP
cm_gnomad_rare$REVEL<-cm_prediction[match(cm_gnomad_rare$key,cm_prediction$key),]$REVEL

nrow(cm_gnomad_rare)
round(c(measureTNR(cm_gnomad_rare$pathogenic,ifelse(cm_gnomad_rare$pathogenicity>=0.10,1,0),0),
measureTNR(cm_gnomad_rare$pathogenic,ifelse(cm_gnomad_rare$MCAP>=0.10,1,0),0),
measureTNR(cm_gnomad_rare$pathogenic,ifelse(cm_gnomad_rare$REVEL>=0.10,1,0),0))*100,1)


data_set<-function(classifer){
  data<-cm_gnomad_rare[,c("pathogenic",classifer)]
  colnames(data)<-c("class","prob_pathogenic")
  data
}

tnr.f<-function(d){
  data<-d
  measureTNR(data$class,ifelse(data$prob_pathogenic>=0.10,1,0),0)
}

p_ada<-data_set("pathogenicity")
p_mcap<-data_set("MCAP")

permutation(p_ada,p_mcap,fun=tnr.f,n=10000)
```

### Benign test set 1 (gnomAD): true negative rate at P<0.05
```{r}
load("../../../data/cardiomyopathy/cm_additional_test_benign.RData")

cm_gnomad_rare$key<-paste(cm_gnomad_rare$CHROM,cm_gnomad_rare$POS,cm_gnomad_rare$REF,cm_gnomad_rare$ALT,sep="_")
cm_gnomad_rare<-cm_gnomad_rare[which(is.element(cm_gnomad_rare$key,cm_prediction$key)==TRUE),]
cm_gnomad_rare$pathogenicity<-cm_prediction[match(cm_gnomad_rare$key,cm_prediction$key),]$pathogenicity
cm_gnomad_rare$MCAP<-cm_prediction[match(cm_gnomad_rare$key,cm_prediction$key),]$MCAP
cm_gnomad_rare$REVEL<-cm_prediction[match(cm_gnomad_rare$key,cm_prediction$key),]$REVEL

nrow(cm_gnomad_rare)
round(c(measureTNR(cm_gnomad_rare$pathogenic,ifelse(cm_gnomad_rare$pathogenicity>=0.05,1,0),0),
measureTNR(cm_gnomad_rare$pathogenic,ifelse(cm_gnomad_rare$MCAP>=0.05,1,0),0),
measureTNR(cm_gnomad_rare$pathogenic,ifelse(cm_gnomad_rare$REVEL>=0.05,1,0),0))*100,1)


data_set<-function(classifer){
  data<-cm_gnomad_rare[,c("pathogenic",classifer)]
  colnames(data)<-c("class","prob_pathogenic")
  data
}

tnr.f<-function(d){
  data<-d
  measureTNR(data$class,ifelse(data$prob_pathogenic>=0.05,1,0),0)
}

p_ada<-data_set("pathogenicity")
p_mcap<-data_set("MCAP")

permutation(p_ada,p_mcap,fun=tnr.f,n=10000)


```


### Benign test set 2 (gnomAD_subset): true negative rate at P<0.1
```{r}
cm_gnomad_rare_noexac<-subset(cm_gnomad_rare,is.na(AF_Adj))
round(c(measureTNR(cm_gnomad_rare_noexac$pathogenic,ifelse(cm_gnomad_rare_noexac$pathogenicity>=0.10,1,0),0),
measureTNR(cm_gnomad_rare_noexac$pathogenic,ifelse(cm_gnomad_rare_noexac$MCAP>=0.10,1,0),0),
measureTNR(cm_gnomad_rare_noexac$pathogenic,ifelse(cm_gnomad_rare_noexac$REVEL>=0.10,1,0),0))*100,1)

nrow(cm_gnomad_rare_noexac)

data_set<-function(classifer){
  data<-cm_gnomad_rare_noexac[,c("pathogenic",classifer)]
  colnames(data)<-c("class","prob_pathogenic")
  data
}

tnr.f<-function(d){
  data<-d
  measureTNR(data$class,ifelse(data$prob_pathogenic>=0.10,1,0),0)
}

p_ada<-data_set("pathogenicity")
p_mcap<-data_set("MCAP")

permutation(p_ada,p_mcap,fun=tnr.f,n=10000)
```

### Benign test set 2 (gnomAD_subset): true negative rate at P<0.05
```{r}
cm_gnomad_rare_noexac<-subset(cm_gnomad_rare,is.na(AF_Adj))
round(c(measureTNR(cm_gnomad_rare_noexac$pathogenic,ifelse(cm_gnomad_rare_noexac$pathogenicity>=0.05,1,0),0),
measureTNR(cm_gnomad_rare_noexac$pathogenic,ifelse(cm_gnomad_rare_noexac$MCAP>=0.05,1,0),0),
measureTNR(cm_gnomad_rare_noexac$pathogenic,ifelse(cm_gnomad_rare_noexac$REVEL>=0.05,1,0),0))*100,1)

nrow(cm_gnomad_rare_noexac)

data_set<-function(classifer){
  data<-cm_gnomad_rare_noexac[,c("pathogenic",classifer)]
  colnames(data)<-c("class","prob_pathogenic")
  data
}

tnr.f<-function(d){
  data<-d
  measureTNR(data$class,ifelse(data$prob_pathogenic>=0.05,1,0),0)
}

p_ada<-data_set("pathogenicity")
p_mcap<-data_set("MCAP")

permutation(p_ada,p_mcap,fun=tnr.f,n=10000)

```

